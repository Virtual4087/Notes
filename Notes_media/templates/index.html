{% extends "layout.html" %}
{% block body %}
    {% if user.is_authenticated %}
        <form action="{% url 'index' %}" method="post" enctype="multipart/form-data" autocomplete="off">
            {% csrf_token %}
            <label for="title">Title</label>
            <input type="text" name="title" required>
            <br>
            <label for="body">Body</label>
            <textarea name="description" id="" cols="30" rows="10" required></textarea>
            <br>
            <label for="image">Images</label>
            <input type="file" name="image" accept="image/*">
            <br>
            <label for="pdf_file">Pdf file</label>
            <input type="file" name="pdf_file" accept=".pdf">
            <br>
            <input type="submit">
        </form>
        {% if messages %}
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
        {% endif %}
    {% endif %}
    <div>
        {% for post in posts %}
            <div id={{post.id}} style="padding: 20px; background-color: azure; width: 100%;" data-csrf="{{csrf_token}}">
                <div>{{post.user.username}}</div>
                <div>{{post.date}}</div>
                <div>{{post.title}}</div>
                <div style="white-space: pre-line; word-wrap: break-word;">{{post.description}}</div>
                {% if post.image %}
                    <img src="{{post.image.first.image.url}}" width="200px">
                {% endif %}
                {% if post.file %}
                    <div><a href="{{post.file.url}}" download="">download</a></div>
                {% endif %}
                <div class="select-none">
                    {% if user.is_authenticated %}
                        {% if user in post.like.all %}
                            <i class="fa-solid fa-thumbs-up cursor-pointer like-unlike" id="unlike"></i>
                        {% else %}
                            <i class="fa-regular fa-thumbs-up cursor-pointer like-unlike" id="like"></i>
                        {% endif %}
                    {% else %}
                        <i class="fa-regular fa-thumbs-up"></i>
                    {% endif %}
                    <span id="like-count">{{post.like.count}}</span>
                </div>
                <button id="delete_post">Delete</button>
            </div>
            <br>
            <br>
        {% endfor %}
    </div>
    <script>
        const like_buttons = document.querySelectorAll(".like-unlike")
        const delete_buttons = document.querySelectorAll("#delete_post")
        like_buttons.forEach((like) =>{
            like.addEventListener("click", () => {
                const post = like.parentElement.parentElement
                const like_count = post.querySelector("#like-count")
                fetch(`/${post.id}/edit`, {
                    method : "POST",
                    headers : {
                        "Source" : "like_unlike",
                        "Content-Type" : "application/json",
                        "X-CSRFToken" : post.dataset.csrf
                    },
                    body : JSON.stringify({
                        perform : like.id
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                })
                if (like.id == "like"){
                    like.id = "unlike"
                    like.classList.remove("fa-regular")
                    like.classList.add("fa-solid")
                    like_count.innerText = parseInt(like_count.innerText) + 1
                }
                else{
                    like.id = "like"
                    like.classList.remove("fa-solid")
                    like.classList.add("fa-regular")
                    like_count.innerText = parseInt(like_count.innerText) - 1
                }
            })
        })

        delete_buttons.forEach((button) => {
            button.addEventListener("click", () => {
                const post = button.parentElement
                post.style.display = "none";
                fetch(`/${post.id}/edit`, {
                        method : "DELETE",
                        headers : {
                            "Source" : "delete_post",
                            "Content-Type" : "application/json",
                            "X-CSRFToken" : post.dataset.csrf
                        },
                        body : JSON.stringify({
                            perform : "delete"
                        })
                    })
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                })
            })
        })
        
    </script>
{% endblock %}